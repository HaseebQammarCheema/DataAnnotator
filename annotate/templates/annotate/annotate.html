<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta http-equiv='X-UA-Compatible' content='ie=edge'>
    <title>Annotate - Markup</title>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,700" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="/static/favicon.ico/"/>
</head>
<body>
    <div id='config_data' style='max-width:33%; float:left; padding:75px; font-size:1.2em; font-family:"Nunito";'>
        {% for key, value in dict.items %}
            {% if key != 'file_data' and key != 'ann_filename' %}
                <b>{{ key }}</b>
                    <br>
                    {% if key == 'attributes' %}
                        {% for val in value %}
                            <input type='checkbox' id="{{ val }}" name='{{ key }}' value='{{ val }}'>
                            <label for="{{ val }}">{{ val }}</label>
                            <br>
                        {% endfor %}
                    {% else %}
                        {% for val in value %}
                            <input type='radio' id="{{ val }}" name='{{ key }}' value='{{ val }}'>
                            <label for="{{ val }}">{{ val }}</label>
                            <br>
                        {% endfor %}
                    {% endif %}
                    <br>
            {% endif %}
        {% endfor %}

        <button id='addAnnotation' style='background-color:rgb(210, 210, 210); padding:7.5px; color:white; border-radius:5px; font-weight:bold; border:none; font-size:0.75em; font-family:"Nunito";'>Add Annotation</button>
        <button id='clearSelections' style='background-color:rgb(210, 210, 210); padding:7.5px; color:white; border-radius:5px; font-weight:bold; border:none; font-size:0.75em; font-family:"Nunito";'>Clear</button>
        <button id='hideStopwords' style='width: 130px; background-color:rgb(210, 210, 210); padding:7.5px; color:white; border-radius:5px; font-weight:bold; border:none; font-size:0.75em; font-family:"Nunito";'>Hide Stopwords</button>
        <a href="" id="downloadButton" download="{{ dict.ann_filename }}"><button id='saveAnnotations' style='background-color:rgb(210, 210, 210); padding:7.5px; color:white; border-radius:5px; font-weight:bold; border:none; font-size:0.75em; font-family:"Nunito";'>Save</button></a>
    </div>

    <div id='file_data' style='float:left; max-width:50%; word-wrap:break-word; padding:75px; font-size:1.2em; font-family:"Nunito"; outline:0px solid transparent;'>
        {% for line in dict.file_data %}
            {% for word in line.split %}
                <span class='{{ word|lower }}'>
                {{ word }}
                </span>
            {% endfor %}
            <br>
        {% endfor %}
    </div>

    <script>
        var allAnnotations = [];
        var stopwordsHidden = false;
        $(document).ready(function() {

            var entityIndex = 1;
            var relationIndex = 1;
            var eventIndex = 1;
            var attributeIndex = 1;
            $('#addAnnotation').click(function() {

                // Get start and end indicies of selected text
                var div = document.getElementById('file_data');
                var text = div.innerText;
                
                var sel = getSelection();
                var result = {start: null, end: null};

                if (sel.anchorNode.nodeName == 'DIV') {
                    return;
                }

                ['start', 'end'].forEach(which => {
                    var counter = 1;
                    var tmpNode = div.querySelector('span');
                    var node = which == 'start' ? 'anchor' : 'focus';
                    
                    if (!sel) return;
                        
                    while(tmpNode !== sel[node+'Node'].parentElement) {
                        if (tmpNode != null) {
                            result[which] += tmpNode.innerText.length;
                        }
                        counter++;
                        tmpNode = div.querySelector('span:nth-child(' + counter + ')')
                        }
                        result[which] += sel[node+'Offset'] + (which == 'start' ? 1 : 0);
                    });
                var startIndex, endIndex;
                if (result.start < result.end) {
                    startIndex = result.start;
                    endIndex = result.end;
                } else {
                    startIndex = result.end;
                    endIndex = result.start;
                };

                var highlighted = window.getSelection().toString();

                var hasAnnotation = false; 
                "{% for key, value in dict.items %}"
                    "{% if key != 'file_data' and key != 'ann_filename' %}"
                        if (document.querySelector('input[name="{{ key }}"]:checked') != null) {
                            hasAnnotation = true;
                        }
                    "{% endif %}"
                "{% endfor %}"

                if (highlighted != '' && hasAnnotation) {
                    var annotation = [];
                    document.getElementById('file_data').contentEditable = 'true';
                    document.execCommand('backColor', false, '#33FFB5');
                    document.getElementById('file_data').contentEditable = 'false';

                    "{% for key, value in dict.items %}"
                        "{% if key != 'file_data' and key != 'ann_filename' %}"
                            if (document.querySelector('input[name="{{ key }}"]:checked') != null) {
                                // Implement relations to same annotation properly
                                var id = "";
                                if ("{{ key }}" == 'entities') {
                                    id = "T" + entityIndex;
                                    eventIndex++;
                                } else if ("{{ key }}" == 'attributes') {
                                    id = "A" + attributeIndex;
                                    attributeIndex++;
                                } else if ("{{ key }}" == 'relation') {
                                    id = "R" + relationIndex;
                                    relationIndex++;
                                } else if ("{{ key }}" == 'events') {
                                    id = "E" + eventIndex;
                                    eventIndex++;
                                }
                                annotation.push([id + '\t' + document.querySelector('input[name="{{ key }}"]:checked').value + " " + startIndex + " " + endIndex + "\t" + highlighted + '\n']);
                            }
                        "{% endif %}"
                    "{% endfor %}"
                    allAnnotations.push(annotation);
                }
                window.getSelection().removeAllRanges();
            });

            $('#clearSelections').click(function() {
                "{% for key, value in dict.items %}"
                    "{% if key != 'file_data' and key != 'ann_filename' %}"
                        if (document.querySelector('input[name="{{ key }}"]:checked') != null) {
                            document.querySelector('input[name="{{ key }}"]:checked').checked = false;
                        }
                    "{% endif %}"
                "{% endfor %}"
            });

            $('#hideStopwords').click(function() {
                var stopwords = ["therefore", "see", "able", "yet", "know", "get", "saw", "known", "perhaps", "might", "i", "me", "my", "myself", "we", "our", "ours", "ourselves", "you", "your", "yours", "yourself", "yourselves", "he", "him", "his", "himself", "she", "her", "hers", "herself", "it", "its", "itself", "they", "them", "their", "theirs", "themselves", "what", "which", "who", "whom", "this", "that", "these", "those", "am", "is", "are", "was", "were", "be", "been", "being", "have", "has", "had", "having", "do", "does", "did", "doing", "a", "an", "the", "and", "but", "if", "or", "because", "as", "until", "while", "of", "at", "by", "for", "with", "about", "against", "between", "into", "through", "during", "before", "after", "above", "below", "to", "from", "up", "down", "in", "out", "on", "off", "over", "under", "again", "further", "then", "once", "here", "there", "when", "where", "why", "how", "all", "any", "both", "each", "few", "more", "most", "other", "some", "such", "nor", "not", "only", "own", "same", "so", "than", "too", "very", "s", "t", "can", "will", "just", "don", "should", "now"];
                var wordColor = '';
                if (!stopwordsHidden) {
                    wordColor = '#efeff5';
                    document.getElementById('hideStopwords').innerText = "Show Stopwords";
                    stopwordsHidden = true;
                } else {
                    wordColor = 'black';
                    document.getElementById('hideStopwords').innerText = "Hide Stopwords";
                    stopwordsHidden = false;
                }

                for (var i=0; i < stopwords.length; i++) {
                    var myElements = document.querySelectorAll("." + stopwords[i]);
                    for (var j = 0; j < myElements.length; j++) {
                        myElements[j].style.color = wordColor;
                    }
                }
            });

            var textFile = null;
            $('#saveAnnotations').click(function() {
                var data = new Blob(allAnnotations, {type: 'text/plain'});
                
                if (textFile != null) {
                    window.URL.revokeObjectURL(textFile);
                }

                textFile = window.URL.createObjectURL(data);
                document.getElementById("downloadButton").href = textFile;
            });

        });
    </script>
</body>
</html>